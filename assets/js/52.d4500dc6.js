(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{503:function(a,s,t){"use strict";t.r(s);var e=t(0),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h2",{attrs:{id:"android-overlay机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#android-overlay机制"}},[a._v("#")]),a._v(" Android Overlay机制")]),a._v(" "),s("p",[s("strong",[a._v("Android Overlay")]),a._v(" 是一种资源替换机制，它能在不重新打包 apk 的情况下，覆盖替换 res/ 下的字符和图片等资源。")]),a._v(" "),s("p",[a._v("分为 静态Overlay (Static Resource Overlay) 和 运行时 Overlay (Runtime Resource Overlay) 。")]),a._v(" "),s("p",[a._v("两种 Overlay 方式，都需要资源 id 对应上。大白话就是要替换的资源名称一样、字符串的 id 一样。")]),a._v(" "),s("p",[s("strong",[a._v("静态Overlay （SRO）")]),a._v("：发生在编译时，需要在 Aosp 源码中配置。")]),a._v(" "),s("p",[s("strong",[a._v("运行时Overlay （RRO")]),a._v("）：发生在运行时，可以直接覆盖替换其他 apk 的资源而不需要其源码。")]),a._v(" "),s("h2",{attrs:{id:"静态overlay-sro"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#静态overlay-sro"}},[a._v("#")]),a._v(" 静态Overlay （SRO）")]),a._v(" "),s("p",[a._v("可以替换 string.xml 、图片、layout、anim、xml目录中的 xml 文件 。")]),a._v(" "),s("p",[a._v("常用场景：覆盖替换 frameworks/ 、packages/ 目录下的资源文件。如改翻译词条、图片、改默认值等。")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("frameworks/base/core/res/res/drawable-xxxhdpi/\nframeworks/base/core/res/res/layout-xxxhdpi/\nframeworks/base/core/res/res/values/\nframeworks/base/packages/SettingsProvider/res/values/defaults.xml\npackages/apps/Bluetooth/res/values/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("h3",{attrs:{id:"_1-配置-overlay-目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置-overlay-目录"}},[a._v("#")]),a._v(" 1.配置 overlay 目录")]),a._v(" "),s("p",[a._v("在 Aosp 源码下下找到 "),s("code",[a._v("PRODUCT_PACKAGE_OVERLAYS")]),a._v(" 的定义，一般都配置在 device 目录下，如 device/xxx/yyy/device.mk ，")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# overlay")]),a._v("\nPRODUCT_PACKAGE_OVERLAYS :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("device/xxx/yyy/overlay\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h3",{attrs:{id:"_2-替换资源文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-替换资源文件"}},[a._v("#")]),a._v(" 2.替换资源文件")]),a._v(" "),s("p",[a._v("在 device/xxx/yyy/overlay 下按照 frameworks 目录新建对应的文件夹，放入要替换的文件即可。")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("device/xxx/yyy/overlay/frameworks/\ndevice/xxx/yyy/overlay/packages/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h3",{attrs:{id:"_3-全编译验证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-全编译验证"}},[a._v("#")]),a._v(" 3.全编译验证")]),a._v(" "),s("p",[a._v("全编译验证即可。")]),a._v(" "),s("h2",{attrs:{id:"运行时-overlay-rro"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运行时-overlay-rro"}},[a._v("#")]),a._v(" 运行时 Overlay (RRO)")]),a._v(" "),s("p",[a._v("可以替换 string.xml 、图片，不能替换 layout、anim、xml 目录中的 xml 文件 。")]),a._v(" "),s("p",[a._v("常用场景：覆盖替换目标 apk 的翻译词条、图片资源等。")]),a._v(" "),s("p",[a._v("假设当前已有 Test.apk ，包名是 com.test 。我们用 运行时 Overlay 的形式替换它的 翻译词条和图片。")]),a._v(" "),s("h3",{attrs:{id:"_1-新建-xxxoverlay-目录-创建-android-mk"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-新建-xxxoverlay-目录-创建-android-mk"}},[a._v("#")]),a._v(" 1.新建 xxxOverlay 目录，创建 Android.mk")]),a._v(" "),s("p",[a._v("新建 TestOverlay 目录，在目录下创建 Android.mk ，")]),a._v(" "),s("p",[a._v("写入这些内容，")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("LOCAL_PATH :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("call my-dir"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n\npackage_name :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" com.zeasn.ru_toptech\ncustomer_overlay :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" vendor/toptech/.build/overlay\ninclude "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("CLEAR_VARS"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n\nLOCAL_IS_RUNTIME_RESOURCE_OVERLAY :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\nLOCAL_PACKAGE_NAME :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("package_name"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(".overlay\nLOCAL_CERTIFICATE :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" platform\nLOCAL_MODULE_PATH :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("TARGET_OUT_VENDOR"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/overlay\nLOCAL_RESOURCE_DIR :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("\nifeq "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("shell "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" -e "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("$(")]),a._v("customer_overlay"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("$(")]),a._v("package_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("/res "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("yes")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(",yes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\nLOCAL_RESOURCE_DIR "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("customer_overlay"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/"),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("package_name"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/res\nendif\nLOCAL_RESOURCE_DIR "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("LOCAL_PATH"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/res\nLOCAL_AAPT_INCLUDE_ALL_RESOURCES :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\nLOCAL_SDK_VERSION :"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" system_current\nLOCAL_AAPT_FLAGS "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v(" --auto-add-overlay\ninclude "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("BUILD_PACKAGE"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br")])]),s("p",[a._v("LOCAL_CERTIFICATE 可以写 shared 、platform ，取决于对签名的要求。")]),a._v(" "),s("p",[a._v("LOCAL_MODULE_PATH := $(TARGET_OUT_VENDOR)/overlay ，说明编译后生成的 apk 路径在 vendor/overlay/com.zeasn.ru_toptech.overlay.apk 。这个路径可以根据不同方案进行调整。")]),a._v(" "),s("h3",{attrs:{id:"_2-创建-androidmanifest-xml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建-androidmanifest-xml"}},[a._v("#")]),a._v(" 2.创建 AndroidManifest.xml")]),a._v(" "),s("p",[a._v("创建 AndroidManifest.xml ，写入")]),a._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("manifest")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("xmlns:")]),a._v("android")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("http://schemas.android.com/apk/res/android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("package")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("com.zeasn.ru_toptech.overlay"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("android:")]),a._v("versionCode")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("android:")]),a._v("versionName")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("1.0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("overlay")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("android:")]),a._v("priority")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("android:")]),a._v("targetPackage")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("com.zeasn.ru_toptech"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("android:")]),a._v("isStatic")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("true"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("/>")])]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("manifest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br")])]),s("p",[a._v("package=“com.zeasn.ru_toptech.overlay” 是后面编译生成的 TestOverlay.apk 的包名。")]),a._v(" "),s("p",[a._v("targetPackage 是目标 apk 的包名。")]),a._v(" "),s("h3",{attrs:{id:"_3-放入资源文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-放入资源文件"}},[a._v("#")]),a._v(" 3.放入资源文件")]),a._v(" "),s("p",[a._v("创建 xxxOverlay/res/ 目录，放入对应的文件即可，目录机构如 apk 源码目录结构是一样的。")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("xxxOverlay/res/values/strings.xml\nxxxOverlay/res/values-fa/strings.xml\nxxxOverlay/res/drawable-hdpi/pic1.png\nxxxOverlay/res/mipmap-hdpi/mip1.png\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("需要留意，即使只是想替换 values-fa/strings.xml 里的字符串，values/strings.xml 里也要加上对应的字符串，要不然会替换不成功。")]),a._v(" "),s("h2",{attrs:{id:"_4-编译"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-编译"}},[a._v("#")]),a._v(" 4.编译")]),a._v(" "),s("p",[a._v("修改 device/xxx/yyy/device.mk ，把 xxxOverlay 加入编译，")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("PRODUCT_PACKAGES "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("FileManagerOverlay "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("单编得到 xxxOverlay.apk , push 到机器上验证即可。")])])}),[],!1,null,null,null);s.default=r.exports}}]);