(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{519:function(s,a,t){"use strict";t.r(a);var n=t(0),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"特权应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#特权应用"}},[s._v("#")]),s._v(" 特权应用")]),s._v(" "),a("p",[s._v("什么是特权应用？位于系统分区的"),a("code",[s._v("priv-app")]),s._v("目录下的应用就是特权应用。不同的Android版本定义的分区如下")]),s._v(" "),a("ol",[a("li",[s._v("小于等于Android 8.1的版本，特权分区为"),a("code",[s._v("/system")]),s._v("。")]),s._v(" "),a("li",[s._v("大于等于Android 9的版本，特权分区为"),a("code",[s._v("/system")]),s._v(", "),a("code",[s._v("/product")]),s._v("和"),a("code",[s._v("/vendor")]),s._v("。")])]),s._v(" "),a("p",[s._v("例如，从Android 9开始，"),a("code",[s._v("/product/priv-app")]),s._v("目录下的应用就是特权应用。")]),s._v(" "),a("h2",{attrs:{id:"系统的特许权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统的特许权限"}},[s._v("#")]),s._v(" 系统的特许权限")]),s._v(" "),a("p",[s._v("从Android 8.0开始，特权应用如果使用系统的特许权限，那么需要把这个特许权限加入到白名单中。"),a("br"),s._v("\n那么什么是系统的特许权限? 系统的特许权限必须在frameworks/base/core/res/AndroidManifest.xml定义，并且等级为signature|privileged")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("permission")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("android:")]),s._v("name")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("com.permission.test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("android:")]),s._v("protectionLevel")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("signature|privileged"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"白名单文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#白名单文件"}},[s._v("#")]),s._v(" 白名单文件")]),s._v(" "),a("p",[s._v("刚才说到，如果一个特权应用使用了系统的特许权限，那么我们要把这个特许权限加入到白名单中。")]),s._v(" "),a("p",[s._v("那么这个白名单文件在哪呢？如果特权应用在"),a("code",[s._v("/vendor")]),s._v("分区，那么白名单文件就必须在"),a("code",[s._v("/vendor/etc/permissions/")]),s._v("目录下。")]),s._v(" "),a("p",[s._v("那么这些白名单文件来自哪里呢？一般是来自"),a("code",[s._v("frameworks/base/data/etc/")]),s._v("目录，也有的是来自应用，这些应用通过"),a("code",[s._v("Android.mk")]),s._v("或"),a("code",[s._v("Android.bp")]),s._v("把白名单文件编译到指定目录。")]),s._v(" "),a("p",[s._v("这里以"),a("code",[s._v("frameworks/base/data/etc/")]),s._v("目录为例，在我的项目中有如下文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Android.bp\ncom.android.carrierconfig.xml\ncom.android.contacts.xml\ncom.android.dialer.xml\ncom.android.documentsui.xml\ncom.android.emergency.xml\ncom.android.launcher3.xml\ncom.android.provision.xml\ncom.android.settings.intelligence.xml\ncom.android.settings.xml\ncom.android.storagemanager.xml\ncom.android.systemui.xml\ncom.android.timezone.updater.xml\nframework-sysconfig.xml\nhiddenapi-package-whitelist.xml\nplatform.xml\nprivapp-permissions-platform.xml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("特权应用如果使用了系统特许权限，一般会把白名单添加到"),a("code",[s._v("privapp-permissions-platform.xml")]),s._v("文件中。当然也可以单独建立一个文件，例如"),a("code",[s._v("com.android.systemui.xml")]),s._v("就是"),a("code",[s._v("SystemUI")]),s._v("的特权白名单文件。")]),s._v(" "),a("p",[s._v("那么这些白名单文件如何编译到系统分区呢，这是由frameworks/base/data/etc/Android.bp决定的，部分代码如下")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[s._v('prebuilt_etc {\n    // 配置文件的别名\n    name: "privapp-permissions-platform.xml",\n    // 配置文件的目录\n    sub_dir: "permissions",\n    // 源配置文件名\n    src: "privapp-permissions-platform.xml",\n}\n\nprebuilt_etc {\n    name: "privapp_whitelist_com.android.carrierconfig",\n    // 配置文件添加到product分区\n    product_specific: true,\n    sub_dir: "permissions",\n    src: "com.android.carrierconfig.xml",\n    filename_from_src: true,\n}\n\nprebuilt_etc {\n    name: "privapp_whitelist_com.android.settings",\n\t// 配置文件添加到system_ext分区\n    system_ext_specific: true,\n    sub_dir: "permissions",\n    src: "com.android.settings.xml",\n    filename_from_src: true,\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("第一个"),a("code",[s._v("prebuilt_etc")]),s._v("模块是把"),a("code",[s._v("privapp-permissions-platform.xml")]),s._v("默认编译到"),a("code",[s._v("/system")]),s._v("分区下的"),a("code",[s._v("/system/etc/permissions")]),s._v("目录下。")]),s._v(" "),a("p",[s._v("第二个"),a("code",[s._v("prebuilt_etc")]),s._v("模块，由于定义了"),a("code",[s._v("product_specific: true")]),s._v("，所以把配置文件编译到"),a("code",[s._v("/product")]),s._v("分区。")]),s._v(" "),a("p",[s._v("第三个"),a("code",[s._v("prebuilt_etc")]),s._v("模块，由于定义了"),a("code",[s._v("system_ext_specific: true")]),s._v("，所以把配置文件编译到"),a("code",[s._v("/system_ext")]),s._v("分区。")]),s._v(" "),a("blockquote",[a("p",[s._v("由于对Android.bp语法缺乏了解，暂时不知道如何把配置文件编译到vendor分区")])]),s._v(" "),a("h2",{attrs:{id:"为特权应用添加白名单"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为特权应用添加白名单"}},[s._v("#")]),s._v(" 为特权应用添加白名单")]),s._v(" "),a("p",[s._v("假如现在我在"),a("code",[s._v("frameworks/base/core/res/AndroidManifest.xml")]),s._v("中定义了如下一个特权")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("permission")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("android:")]),s._v("name")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("com.permission.test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("android:")]),s._v("protectionLevel")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("signature|privileged"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("然后在"),a("code",[s._v("SettingsProvider")]),s._v("的"),a("code",[s._v("AndroidManifest.xml")]),s._v("中使用了这个权限")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("uses-permission")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("android:")]),s._v("name")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("com.permission.test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("由于"),a("code",[s._v("SettingsProvider")]),s._v("属于特权App，并且使用了系统的特许权限，那么就要为"),a("code",[s._v("SettingsProvider")]),s._v("添加这个特权白名单。")]),s._v(" "),a("p",[s._v("你可以参照特权白名单文件，为应用添加白名单内容，这需要手动操作。但是如果你已经把源码编译过，那么可以通过执行"),a("code",[s._v("development/tools/privapp_permissions/privapp_permissions.py")]),s._v("这个脚本看到你需要配置的信息，例如对于上面例子，会显示如下信息")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token prolog"}},[s._v('<?xml version="1.0" encoding="utf-8"?>')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("permissions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("privapp-permissions")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("package")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("com.android.providers.settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("permission")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("com.permission.test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("privapp-permissions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("permissions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这就是白名单内容，我们可以把这个内容放到"),a("code",[s._v("frameworks/base/data/etc/privapp-permissions-platform.xml")]),s._v("，也可以单独生成一个文件，名为"),a("code",[s._v("com.android.providers.settings.xml")]),s._v("。如果是生成单独一个文件 ，那么还需要在"),a("code",[s._v("Android.bp")]),s._v("中进行编译配置。")]),s._v(" "),a("h2",{attrs:{id:"查看应用权限赋予情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看应用权限赋予情况"}},[s._v("#")]),s._v(" 查看应用权限赋予情况")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("adb shell dumpsys package com.test.abc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("备注：com.test.abc改成你的包名。")]),s._v(" "),a("p",[s._v("搜索“"),a("strong",[s._v("runtime permissions")]),s._v("，有如下结果。 很明显可看到 位置权限，存储空间 权限没有被赋予。")]),s._v(" "),a("p",[s._v("输入 "),a("strong",[a("code",[s._v("adb shell dumpsys package com.test.abc >> D:\\log.txt")])]),s._v(" 可将以上信息保存到log中。搜集这个log，方便排查下些bug原因。")]),s._v(" "),a("p",[s._v("本文转自 "),a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/165646349",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://zhuanlan.zhihu.com/p/165646349"),a("OutboundLink")],1),s._v("，如有侵权，请联系删除。")])])}),[],!1,null,null,null);a.default=e.exports}}]);